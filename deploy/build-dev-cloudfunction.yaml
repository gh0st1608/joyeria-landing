steps:
  # 1️⃣ Construcción de la imagen Docker
  - name: 'gcr.io/cloud-builders/docker'
    args: ['build', '--tag', 'us-central1-docker.pkg.dev/oval-crawler-444615-k3/joyasperu-apiscore/msa-notification-serverless-img:$COMMIT_SHA', '-f', './backend/notification/Dockerfile', './backend/notification']

  # 2️⃣ Subida de la imagen a Artifact Registry
  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', 'us-central1-docker.pkg.dev/oval-crawler-444615-k3/joyasperu-apiscore/msa-notification-serverless-img:$COMMIT_SHA']

  # 3️⃣ Despliegue de la Cloud Function desde el contenedor
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: 'gcloud'
    args:
      - 'functions'
      - 'deploy'
      - 'notificationService'
      - '--region=us-central1'
      - '--memory=512MB'
      - '--allow-unauthenticated'
      - '--trigger-http'
      - '--runtime=nodejs20'
      - '--gen2' # Indica que usas Cloud Functions 2da Generación (necesario para imágenes Docker)
      - '--timeout=60s'
      - '--image=us-central1-docker.pkg.dev/oval-crawler-444615-k3/joyasperu-apiscore/msa-notification-serverless-img:$COMMIT_SHA'
      - '--entry-point=notificationHandler' # Asegúrate de exportar esta función en main.ts

images:
  - 'us-central1-docker.pkg.dev/oval-crawler-444615-k3/joyasperu-apiscore/msa-notification-serverless-img:$COMMIT_SHA'

options:
  logging: CLOUD_LOGGING_ONLY
